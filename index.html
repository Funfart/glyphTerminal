<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Glyph Terminal v2.7 Mobile Runtime</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

<style>

:root{
 --neon:#00ff88;
 --bg:#000;
 --panel:rgba(0,0,0,0.85);
}

body{
 margin:0;
 background:var(--bg);
 color:var(--neon);
 font-family:monospace;
 overflow:hidden;
}

#controls{
 position:fixed;
 top:0;
 left:0;
 right:0;
 backdrop-filter:blur(12px);
 background:var(--panel);
 padding:10px env(safe-area-inset-top);
 border-bottom:1px solid var(--neon);
 z-index:10;
}

#controls.collapsed textarea,
#controls.collapsed input{
 display:none;
}

textarea{
 width:100%;
 height:120px;
 background:#000;
 color:var(--neon);
 border:1px solid var(--neon);
 padding:10px;
 font-size:14px;
}

button,input{
 width:100%;
 padding:12px;
 margin-top:6px;
 font-size:16px;
 background:#000;
 color:var(--neon);
 border:1px solid var(--neon);
 border-radius:8px;
}

canvas{
 position:absolute;
 top:0;
 left:0;
 width:100vw;
 height:100vh;
}

</style>
</head>
<body>

<div id="controls">
<textarea id="input">Welcome to the NFT Terminal.
Mobile Optimized Runtime.
{ hello_world | web3 }</textarea>

<button id="toggle">Encode / Decode</button>
<button id="typeToggle">Play / Pause</button>
<input id="speed" type="range" min="1" max="10" value="4">
<button id="export">Export GIF</button>
</div>

<canvas id="canvas"></canvas>

<script>

/* ================= MOBILE CONFIG ================= */

const DPR=Math.min(window.devicePixelRatio||1,2);
const MOBILE=window.innerWidth<768;

const GLYPH_PATH="./glyphs/";
let GLYPH_SIZE=MOBILE?24:32;
const LINE_HEIGHT=MOBILE?34:46;
const MARGIN=12;
const WAVE_AMPLITUDE=MOBILE?1.2:3;
const WAVE_SPEED=0.03;
const GIF_FPS=12;
const FINAL_HOLD_SECONDS=7;

/* ================= GLYPH MAP ================= */

const glyphMap={a:"1.png",b:"2.png",c:"3.png",d:"4.png",e:"5.png",f:"6.png",g:"7.png",h:"8.png",i:"9.png",j:"10.png",k:"11.png",l:"12.png",m:"13.png",n:"14.png",o:"15.png",p:"16.png",q:"17.png",r:"18.png",s:"19.png",t:"20.png",u:"21.png",v:"22.png",w:"23.png",x:"24.png",y:"25.png",z:"26.png"," ":"space.png","_":"under.png","{":"oBr.png","}":"cBr.png","(":"oB+.png",")":"cB+.png",".":"p.png",";":"semi.png","'":"app.png","=":"eq+.png","/":"fSlash.png","$":"crypto.png",":":"colon.png","<":"less.png",">":"more.png","!":"!.png","&":"&.png","|":"or.png","+":"+.png","-":"-.png","`":"bTick.png",",":"ap.png","%":"pp.png","0":"0.png","1":"1_.png","2":"2_.png","3":"3_.png","4":"4_.png","5":"5_.png","6":"6_.png","7":"7_.png","8":"8_.png","9":"9_.png"};

/* ================= STATE ================= */

let encoded=false;
let glyphCache={};
let typing=true;
let revealIndex=0;
let time=0;

/* ================= CANVAS ================= */

const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d",{willReadFrequently:true});

function resizeCanvas(){
 canvas.width=window.innerWidth*DPR;
 canvas.height=window.innerHeight*DPR;
 ctx.setTransform(DPR,0,0,DPR,0,0);
}
resizeCanvas();
window.addEventListener("resize",resizeCanvas);

/* ================= PRELOAD ================= */

function preloadGlyphs(cb){
 const keys=Object.keys(glyphMap);
 let loaded=0;
 keys.forEach(k=>{
  const img=new Image();
  img.src=GLYPH_PATH+glyphMap[k];
  img.onload=()=>{glyphCache[k]=img;done();}
  img.onerror=()=>{glyphCache[k]=null;done();}
 });
 function done(){loaded++;if(loaded===keys.length)cb();}
}

/* ================= TRANSLATOR ================= */

function encodeText(t){
 return t.split("").map(c=>glyphMap[c.toLowerCase()]?`[${c.toLowerCase()}]`:c).join("");
}
function decodeText(t){
 return t.replace(/\[(.*?)\]/g,(m,p)=>glyphMap[p]?p:m);
}

/* ================= DRAW ================= */

function drawFrame(context,text,t){
 let x=MARGIN;
 let y=MARGIN;

 context.fillStyle="#00ff88";

 for(let i=0;i<text.length;i++){

  const ch=text[i];
  const key=ch.toLowerCase();
  const wave=Math.sin(t+i*0.35)*WAVE_AMPLITUDE;

  if(ch=="\n"){x=MARGIN;y+=LINE_HEIGHT;continue;}

  const adv=glyphMap[key]?GLYPH_SIZE:context.measureText(ch).width+2;
  if(x+adv>window.innerWidth-MARGIN){x=MARGIN;y+=LINE_HEIGHT;}

  if(glyphMap[key]){
   const img=glyphCache[key];
   if(img) context.drawImage(img,x,y+wave,GLYPH_SIZE,GLYPH_SIZE);
   else context.fillRect(x,y,GLYPH_SIZE,GLYPH_SIZE);
   x+=GLYPH_SIZE;
  }else{
   context.fillText(ch,x,y+wave);
   x+=context.measureText(ch).width+2;
  }
 }
}

/* ================= LOOP ================= */

function render(){

 ctx.fillStyle="#000";
 ctx.fillRect(0,0,canvas.width,canvas.height);

 const text=decodeText(document.getElementById("input").value);

 if(typing) revealIndex+=parseInt(document.getElementById("speed").value)/4;

 drawFrame(ctx,text.slice(0,Math.floor(revealIndex)),time);

 time+=WAVE_SPEED;
 requestAnimationFrame(render);
}

/* ================= GIF EXPORT ================= */

function exportGIF(){

const gif=new GIF({
 workers:2,
 quality:10,
 workerScript:"./gif.worker.js"
});

const off=document.createElement("canvas");
off.width=canvas.width/DPR;
off.height=canvas.height/DPR;
const octx=off.getContext("2d",{willReadFrequently:true});

const text=decodeText(document.getElementById("input").value);
let localTime=0;

for(let i=1;i<=text.length;i++){
 octx.fillStyle="#000";
 octx.fillRect(0,0,off.width,off.height);
 drawFrame(octx,text.slice(0,i),localTime);
 gif.addFrame(off,{copy:true,delay:1000/GIF_FPS});
 localTime+=0.1;
}

gif.on("finished",b=>{
 const a=document.createElement("a");
 a.href=URL.createObjectURL(b);
 a.download="glyph-terminal.gif";
 a.click();
});

gif.render();
}

/* ================= CONTROLS ================= */

document.getElementById("toggle").onclick=()=>{
 const input=document.getElementById("input");
 input.value=encoded?decodeText(input.value):encodeText(input.value);
 encoded=!encoded;revealIndex=0;
};

document.getElementById("typeToggle").onclick=()=>typing=!typing;
document.getElementById("export").onclick=exportGIF;

/* ================= MOBILE UX ================= */

document.getElementById("controls").addEventListener("dblclick",()=>{
 document.getElementById("controls").classList.toggle("collapsed");
});

canvas.addEventListener("dblclick",()=>{
 revealIndex=0;
});

/* ================= START ================= */

preloadGlyphs(()=>{render();});

</script>
</body>
</html>
